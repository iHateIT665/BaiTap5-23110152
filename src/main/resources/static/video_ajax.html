<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Video (AJAX)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>
<body class="container mt-4">

    <h2 class="mb-4">Danh sách Video (Gọi qua API)</h2>

    <div class="row mb-3">
        <div class="col-md-6">
            <input type="text" id="keyword" class="form-control" placeholder="Nhập tên video để tìm...">
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary" onclick="searchVideo()">Tìm kiếm</button>
        </div>
    </div>

    <table class="table table-bordered table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Views</th>
                <th>Active</th>
                <th>Category</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody id="videoTableBody">
            </tbody>
    </table>

    <nav>
        <ul class="pagination justify-content-center">
            <li class="page-item"><button class="page-link" onclick="changePage(-1)">Trước</button></li>
            <li class="page-item"><span class="page-link" id="currentPage">Trang 0</span></li>
            <li class="page-item"><button class="page-link" onclick="changePage(1)">Sau</button></li>
        </ul>
    </nav>

    <script>
        var currentPage = 0;
        var currentSize = 5; // Số video mỗi trang

        // 1. Khi trang web load xong thì gọi hàm load dữ liệu
        $(document).ready(function() {
            loadVideos(currentPage);
        });

        // 2. Hàm gọi API lấy danh sách Video
        function loadVideos(page) {
            var url = '/api/videos?page=' + page + '&size=' + currentSize;
            
            // Nếu có từ khóa tìm kiếm thì đổi URL sang API search
            var keyword = $('#keyword').val();
            if (keyword.trim() !== "") {
                url = '/api/videos/search?keyword=' + keyword + '&page=' + page + '&size=' + currentSize;
            }

            $.ajax({
                url: url,
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    // response là đối tượng Page trả về từ Spring Boot
                    var data = response.content; // Lấy list video trong content
                    var html = '';
                    
                    if (data.length === 0) {
                        html = '<tr><td colspan="6" class="text-center">Không tìm thấy dữ liệu</td></tr>';
                    } else {
                        $.each(data, function(index, video) {
                            // Xử lý active (true/false) thành text
                            var activeStatus = video.active ? '<span class="badge bg-success">Hiện</span>' : '<span class="badge bg-secondary">Ẩn</span>';
                            // Xử lý category (tránh null)
                            var categoryName = video.category ? video.category.categoryName : 'Chưa phân loại';

                            html += '<tr>';
                            html += '<td>' + video.videoId + '</td>';
                            html += '<td>' + video.title + '</td>';
                            html += '<td>' + video.views + '</td>';
                            html += '<td>' + activeStatus + '</td>';
                            html += '<td>' + categoryName + '</td>';
                            html += '<td>';
                            html += '<button class="btn btn-danger btn-sm" onclick="deleteVideo(\'' + video.videoId + '\')">Xóa</button>';
                            html += '</td>';
                            html += '</tr>';
                        });
                    }
                    
                    $('#videoTableBody').html(html);
                    $('#currentPage').text('Trang ' + response.number); // Cập nhật số trang hiện tại
                    currentPage = response.number;
                },
                error: function(err) {
                    console.error("Lỗi:", err);
                    alert("Không tải được dữ liệu API!");
                }
            });
        }

        // 3. Hàm chuyển trang
        function changePage(direction) {
            var newPage = currentPage + direction;
            if (newPage < 0) return; // Không cho lùi quá trang 0
            // (Ở đây nên kiểm tra thêm tổng số trang từ response để chặn next quá đà, nhưng tạm thời làm đơn giản)
            loadVideos(newPage);
        }

        // 4. Hàm Tìm kiếm
        function searchVideo() {
            currentPage = 0; // Reset về trang 0 khi tìm kiếm mới
            loadVideos(0);
        }

        // 5. Hàm Xóa Video
        function deleteVideo(id) {
            if (confirm('Bạn có chắc muốn xóa video này không?')) {
                $.ajax({
                    url: '/api/videos/' + id,
                    type: 'DELETE',
                    success: function(result) {
                        alert('Xóa thành công!');
                        loadVideos(currentPage); // Load lại danh sách
                    },
                    error: function(err) {
                        alert('Lỗi khi xóa!');
                    }
                });
            }
        }
    </script>
</body>
</html>